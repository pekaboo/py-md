





## 17. 常见设计模式

### 要点速览 · 17

- 工厂、适配器、代理、模板、策略、责任链核心意图。
- 结合场景说明使用时机。
- 注意与框架实现的联系。

### 基础要点 · 17

- **工厂模式**：隐藏对象创建（Spring IoC 容器、`FactoryBean`）。
- **适配器模式**：接口转换（`HandlerAdapter`, JDBC 驱动）。
- **代理模式**：控制访问、增强（Spring AOP、MyBatis Mapper）。
- **模板方法**：定义算法骨架，子类实现（`JdbcTemplate`）。
- **策略模式**：封装变化算法（支付渠道、序列化）。
- **责任链模式**：多个处理器顺序处理（Servlet Filter、Netty Pipeline）。

### 进阶扩展 · 17

- 组合使用：如策略 + 工厂动态选择实现。
- 借助枚举/注解实现策略注册，减少 `if/else`。
- 使用责任链处理可扩展需求，如审批流。

### ⚠️注意事项 · 17

- 模式选择应基于问题，不要为模式而模式。
- 责任链需处理终止条件，防止空链。
- 策略注册需防止 Bean 重名或覆盖。




## 9. 三高系统设计考量

### 要点速览 · 9

- 三高：高可用、高性能/高并发、高可扩展。
- 架构分层、容量规划、降级限流。
- 数据一致性与容灾策略。

### 基础要点 · 9

- **高可用**：多活部署、故障转移、健康检查、自动化运维。
- **高性能/高并发**：缓存、异步化、读写分离、负载均衡。
- **高可扩展**：拆分服务、弹性伸缩、无状态服务。

### 进阶扩展 · 9

- **容量规划**：QPS 预测、压测、模型计算 Peak Factor。
- **容灾**：跨机房双活/多活、数据复制、RPO/RTO 指标。
- **一致性**：分布式事务（TCC、SAGA）、幂等、补偿。
- **观测**：埋点监控、链路追踪、灰度发布、熔断降级策略。

### ⚠️注意事项 · 9

- 优先解决单点瓶颈，再谈复杂方案。
- 避免过度设计：监控、自动化运维是落地关键。
- 防止缓存雪崩/穿透，设计预热、限流、降级策略。



## 21. 接口防刷方案设计

### 要点速览 · 21

- 多维限流（IP、账号、设备）。
- 黑白名单、设备指纹、验证码。
- 日志审计、异常监控。

### 基础要点 · 21

- **限流**：单 IP、单用户、单接口滑动窗口；慢速模式。
- **黑名单**：响应式封禁恶意 IP/设备。
- **设备指纹**：收集硬件信息、浏览器指纹。

### 进阶扩展 · 21

- **分层架构**：CDN/WAF 初筛 → 网关限流 → 业务限流。
- **动态规则**：结合行为模型、机器学习识别异常。
- **验证码/滑块**：在阈值内渐进触发。
- **风控闭环**：实时监控→人工复核→策略发布；支持灰度。
- **数据采集**：埋点记录请求频率、成功率、UA、Referer。

### ⚠️注意事项 · 21

- 合法高频用户需白名单或提额。
- 设备指纹涉及隐私合规，遵守 GDPR/个人信息保护。
- 限流失败需兜底页面或降级服务，防止直接 500。

## 22. 40 亿 QQ 号、1GB 内存去重方案

### 要点速览 · 22

- 数据量大、内存限制；考虑分桶 + 位图/外排序。
- 布隆过滤器或位图 + 磁盘辅助。
- 控制误判与资源。

### 基础要点 · 22

- 假设 QQ 号为 32 位整数，可用位图：`40e8` 位 ≈ 5 GB，内存不够。
- 采用分治：对数据按哈希写入多个文件（桶），每个桶容量约 1GB 内可处理。

### 进阶扩展 · 22

- **外部排序**：
  1. 遍历数据使用哈希函数将 QQ 号写入 100 个桶文件（磁盘）。
  2. 每次读取一个桶到内存，用位图或排序+去重，再写回。
- **布隆过滤器**：若允许低误判，可用布隆过滤器+磁盘校验；但需谨慎。
- **压缩位图**：`RoaringBitmap` 可压缩稀疏数据；结合磁盘分片。
- **MapReduce/Hadoop**：分布式去重，内存限制不再是单点问题。

### ⚠️注意事项 · 22

- 分桶数需确保单桶数据量 < 可用内存。
- 处理顺序与磁盘 I/O 成本需优化，使用顺序写入避免随机 I/O。
- 考虑数据倾斜（哈希冲突），可使用二级哈希或动态扩容桶。