# Redis 的持久化机制有哪些？

**难度**：中等

**创建时间**：2025-10-06 15:46:03

## 答案
Redis 提供了 **RDB（快照持久化）**、**AOF（日志持久化）** 以及 **混合持久化** 三种核心机制，用于将内存数据持久化到磁盘，确保服务器重启后数据不丢失。以下是详细解析：

### **一、RDB（Redis Database）—— 快照持久化**
**原理**：  
定期将内存中的数据以二进制格式保存到磁盘文件（默认 `dump.rdb`），形成某个时间点的数据快照。

**触发方式**：
1. **手动触发**：
   - `SAVE`：同步执行，阻塞主进程（仅用于测试，生产环境禁用）。
   - `BGSAVE`：异步执行，通过 `fork` 创建子进程生成快照，主进程继续处理请求（生产环境常用）。
2. **自动触发**：  
   在 `redis.conf` 中配置 `save m n`（如 `save 900 1` 表示 900 秒内至少 1 次修改时触发），或通过 `shutdown` 命令正常关闭服务器时触发。

**优点**：
- **恢复速度快**：二进制格式紧凑，加载时直接重建内存数据。
- **适合备份**：可定期生成快照并复制到远程存储。
- **对性能影响小**：`BGSAVE` 通过子进程异步执行，主进程不受阻。

**缺点**：
- **可能丢数据**：两次快照间隔内的修改可能丢失（如配置 `save 60 10000`，则最多丢 60 秒数据）。
- **Fork 开销**：`fork` 子进程时需复制内存页，大内存场景下可能短暂阻塞主进程。

### **二、AOF（Append Only File）—— 日志持久化**
**原理**：  
记录所有写操作命令（如 `SET`、`HSET`），以文本格式追加到 AOF 文件（默认 `appendonly.aof`），重启时通过重放命令恢复数据。

**配置与策略**：
1. **开启 AOF**：  
   在 `redis.conf` 中设置 `appendonly yes`，并指定文件名和路径。
2. **同步策略**（`appendfsync`）：
   - `always`：每条命令立即同步到磁盘（最安全，但性能差）。
   - `everysec`（默认）：每秒同步一次（平衡安全性与性能）。
   - `no`：由操作系统决定同步时机（性能最好，但可能丢数据）。
3. **AOF 重写**：  
   通过 `BGREWRITEAOF` 命令或自动触发（如文件增长超过指定比例），合并冗余命令生成最小化日志，避免文件过大。

**优点**：
- **数据安全性高**：`everysec` 策略下最多丢 1 秒数据。
- **可读性强**：文本格式，便于编辑和恢复（如误删数据时可手动修改 AOF 文件）。
- **支持灵活恢复**：即使 RDB 备份损坏，也可通过 AOF 恢复。

**缺点**：
- **文件体积大**：相比 RDB，AOF 记录所有命令，占用更多磁盘空间。
- **恢复速度慢**：需逐条重放命令，大数据集时恢复耗时。
- **重写开销**：频繁重写可能影响性能。

### **三、混合持久化（Redis 4.0+）**
**原理**：  
结合 RDB 和 AOF 的优势，生成的文件前半部分是 RDB 快照，后半部分是 AOF 增量日志。重启时先加载 RDB 部分快速恢复基础数据，再重放 AOF 日志补充增量修改。

**配置**：  
在 `redis.conf` 中设置 `aof-use-rdb-preamble yes`。

**优点**：
- **恢复速度快**：RDB 部分加速初始恢复，AOF 部分确保数据完整性。
- **减少 AOF 体积**：避免全量日志记录，仅存储增量修改。

**适用场景**：  
对数据安全性和恢复速度均有较高要求的场景（如金融、电商）。

### **四、持久化机制对比与选型建议**
| **机制**   | **数据安全性** | **恢复速度** | **性能影响** | **适用场景**               |
|------------|----------------|--------------|--------------|----------------------------|
| **RDB**    | 低（可能丢数据） | 快           | 小（异步）   | 缓存场景、定期备份         |
| **AOF**    | 高（可配置策略） | 慢           | 中（同步开销） | 持久化存储、数据不能丢失   |
| **混合持久化** | 高             | 较快         | 中           | 平衡性能与安全性的场景     |

**选型建议**：
- **仅作为缓存**：可关闭持久化（`save ""` + `appendonly no`）。
- **追求性能**：使用 RDB（如每 6 小时 `BGSAVE` 备份）。
- **追求数据安全**：使用 AOF（`everysec` 策略）。
- **平衡需求**：使用混合持久化（Redis 4.0+ 推荐）。
